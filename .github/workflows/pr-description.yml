name: Auto PR Description

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    if: github.event.pull_request.body == '' || github.event.pull_request.body == null

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          echo "files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Generate PR description
        id: generate-description
        run: |
          # ì»¤ë°‹ ë©”ì‹œì§€ë“¤ ê°€ì ¸ì˜¤ê¸°
          COMMITS=$(git log --oneline ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})

          # ë³€ê²½ëœ íŒŒì¼ë“¤
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"

          # PR ë””ìŠ¤í¬ë¦½ì…˜ ìƒì„±
          cat > pr_description.md << 'EOF'
          ## ðŸ“‹ ë³€ê²½ì‚¬í•­ ìš”ì•½

          ### ðŸ”„ ì»¤ë°‹ ížˆìŠ¤í† ë¦¬
          ```
          $COMMITS
          ```

          ### ðŸ“ ë³€ê²½ëœ íŒŒì¼ë“¤
          ```
          $CHANGED_FILES
          ```

          ### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
          - [ ] í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
          - [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
          - [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ í™•ì¸
          - [ ] ë¸Œë ˆì´í‚¹ ì²´ì¸ì§€ ì—†ìŒ

          ### ðŸ“ ì¶”ê°€ ì •ë³´
          ì´ PRì— ëŒ€í•œ ìžì„¸í•œ ì„¤ëª…ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
          EOF

      - name: Update PR description
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const description = fs.readFileSync('pr_description.md', 'utf8');

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: description
            });
